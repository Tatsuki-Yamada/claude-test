AWSTemplateFormatVersion: '2010-09-09'
Description: 'CI/CD Pipeline for Game Collection App'

Parameters:
  AppName:
    Type: String
    Default: 'game-collection'
    Description: 'Application name used for naming resources'
  
  Environment:
    Type: String
    Default: 'dev'
    AllowedValues:
      - 'dev'
      - 'prod'
    Description: 'Environment (dev or prod)'
  
  RepositoryName:
    Type: String
    Default: 'claude-test'
    Description: 'GitHub repository name'
  
  RepositoryOwner:
    Type: String
    Default: 'Tatsuki-Yamada'
    Description: 'GitHub repository owner'
  
  GitHubOAuthToken:
    Type: String
    NoEcho: true
    Description: 'GitHub OAuth Token for CodePipeline'
  
  Branch:
    Type: String
    Default: 'main'
    Description: 'Repository branch to deploy'

Conditions:
  # 条件: CloudFront無効化機能が存在するかどうかを確認
  HasCloudFrontInvalidationFunction: !Not [!Equals [!Sub '', !Sub '']]

Resources:
  # CI/CD Pipeline
  GameCollectionPipeline:
    Type: 'AWS::CodePipeline::Pipeline'
    Properties:
      Name: !Sub '${AppName}-${Environment}-pipeline'
      RoleArn: {'Fn::ImportValue': !Sub '${AppName}-${Environment}-CodePipelineServiceRoleArn'}
      ArtifactStore:
        Type: S3
        Location: {'Fn::ImportValue': !Sub '${AppName}-${Environment}-ArtifactsBucketName'}
      Stages:
        # Source Stage
        - Name: Source
          Actions:
            - Name: Source
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: '1'
              Configuration:
                Owner: !Ref RepositoryOwner
                Repo: !Ref RepositoryName
                Branch: !Ref Branch
                OAuthToken: !Ref GitHubOAuthToken
              OutputArtifacts:
                - Name: SourceCode
        
        # Deploy CodeBuild Project for Frontend
        - Name: DeployCodeBuildProject
          Actions:
            - Name: DeployFrontendBuildProject
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                RoleArn: {'Fn::ImportValue': !Sub '${AppName}-${Environment}-CloudFormationServiceRoleArn'}
                StackName: !Sub '${AppName}-${Environment}-frontend-build'
                TemplatePath: 'SourceCode::infrastructure/codebuild/frontend-build.yaml'
                ParameterOverrides: !Sub |
                  {
                    "AppName": "${AppName}",
                    "Environment": "${Environment}",
                    "CodeBuildServiceRoleArn": {"Fn::ImportValue": "${AppName}-${Environment}-CodeBuildServiceRoleArn"}
                  }
                Capabilities: CAPABILITY_NAMED_IAM
              InputArtifacts:
                - Name: SourceCode
              RunOrder: 1
        
        # Deploy Lambda for CloudFront Invalidation
        - Name: DeployLambdaFunction
          Actions:
            - Name: DeployCloudFrontInvalidationFunction
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                RoleArn: {'Fn::ImportValue': !Sub '${AppName}-${Environment}-CloudFormationServiceRoleArn'}
                StackName: !Sub '${AppName}-${Environment}-cf-invalidation'
                TemplatePath: 'SourceCode::infrastructure/lambda/cf-invalidation.yaml'
                ParameterOverrides: !Sub |
                  {
                    "AppName": "${AppName}",
                    "Environment": "${Environment}",
                    "LambdaExecutionRoleArn": {"Fn::ImportValue": "${AppName}-${Environment}-LambdaExecutionRoleArn"},
                    "FrontendStackName": "${AppName}-${Environment}-frontend-infra"
                  }
                Capabilities: CAPABILITY_NAMED_IAM
              InputArtifacts:
                - Name: SourceCode
              RunOrder: 1
        
        # Deploy Auth Stack
        - Name: DeployAuthStack
          Actions:
            - Name: DeployAuthStack
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                RoleArn: {'Fn::ImportValue': !Sub '${AppName}-${Environment}-CloudFormationServiceRoleArn'}
                StackName: !Sub '${AppName}-${Environment}-auth'
                TemplatePath: 'SourceCode::infrastructure/auth/template.yaml'
                TemplateConfiguration: 'SourceCode::infrastructure/auth/config.json'
                ParameterOverrides: !Sub |
                  {
                    "AppName": "${AppName}",
                    "Environment": "${Environment}"
                  }
                Capabilities: CAPABILITY_NAMED_IAM
              InputArtifacts:
                - Name: SourceCode
              RunOrder: 1
        
        # Deploy Storage Stack
        - Name: DeployStorageStack
          Actions:
            - Name: DeployStorageStack
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                RoleArn: {'Fn::ImportValue': !Sub '${AppName}-${Environment}-CloudFormationServiceRoleArn'}
                StackName: !Sub '${AppName}-${Environment}-storage'
                TemplatePath: 'SourceCode::infrastructure/storage/template.yaml'
                ParameterOverrides: !Sub |
                  {
                    "AppName": "${AppName}",
                    "Environment": "${Environment}"
                  }
                Capabilities: CAPABILITY_NAMED_IAM
              InputArtifacts:
                - Name: SourceCode
              RunOrder: 1
        
        # Deploy API Stack
        - Name: DeployAPIStack
          Actions:
            - Name: DeployAPIStack
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                RoleArn: {'Fn::ImportValue': !Sub '${AppName}-${Environment}-CloudFormationServiceRoleArn'}
                StackName: !Sub '${AppName}-${Environment}-api'
                TemplatePath: 'SourceCode::infrastructure/api/template.yaml'
                ParameterOverrides: !Sub |
                  {
                    "AppName": "${AppName}",
                    "Environment": "${Environment}"
                  }
                Capabilities: CAPABILITY_NAMED_IAM
              InputArtifacts:
                - Name: SourceCode
              RunOrder: 1
              
        # Deploy Frontend Infrastructure Stack
        - Name: DeployFrontendInfraStack
          Actions:
            - Name: DeployFrontendInfraStack
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CREATE_UPDATE
                RoleArn: {'Fn::ImportValue': !Sub '${AppName}-${Environment}-CloudFormationServiceRoleArn'}
                StackName: !Sub '${AppName}-${Environment}-frontend-infra'
                TemplatePath: 'SourceCode::infrastructure/frontend/template.yaml'
                ParameterOverrides: !Sub |
                  {
                    "AppName": "${AppName}",
                    "Environment": "${Environment}"
                  }
                Capabilities: CAPABILITY_NAMED_IAM
              InputArtifacts:
                - Name: SourceCode
              RunOrder: 1
        
        # Build Frontend
        - Name: BuildFrontend
          Actions:
            - Name: BuildFrontend
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              Configuration:
                ProjectName: {"Fn::ImportValue": !Sub '${AppName}-${Environment}-FrontendBuildProjectName'}
              InputArtifacts:
                - Name: SourceCode
              OutputArtifacts:
                - Name: BuildOutput
        
        # Deploy Frontend
        - Name: DeployFrontend
          Actions:
            - Name: DeployToS3
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: S3
                Version: '1'
              Configuration:
                BucketName: {'Fn::ImportValue': !Sub '${AppName}-${Environment}-WebsiteBucketName'}
                Extract: true
              InputArtifacts:
                - Name: BuildOutput
              RunOrder: 1
            
            # CloudFront無効化ステップを条件付きで実行
            # このステップは削除し、代わりに別の実装方法を使用します

Outputs:
  PipelineURL:
    Description: 'URL to the CodePipeline console'
    Value: !Sub 'https://console.aws.amazon.com/codepipeline/home?region=${AWS::Region}#/view/${GameCollectionPipeline}'
